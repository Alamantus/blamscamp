<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>blamscamp player</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script type="text/javascript" src="jszip.min.js"></script>
  </head>
  <template id="song">
    <div class="song well">
      <button class="remove_song">remove song</button>
      <input class="song_title" type="text" placeholder="song title"/>
      <input class="song_file" type="file"/>
    </div>
  </template>
  <body>
    <div class="editor">
      <h1>blamscamp player</h1>
      <p>create a bandcamp-style audio player for selling albums on itch.io</p>
      <!-- <button>import zip</button> -->
      <div><input class="meta_fields" type="text" placeholder="album title" id="album"/></div>
      <div><input class="meta_fields" type="text" placeholder="artist name" id="artist"/></div>
      <div>cover art: <input type="file" id="cover"/></div>
      <div class="songs">
        <div class="well">
          <button id="add_song">add song</button>
        </div>
      </div>

      <button id="generate">generate</button>
      <button id="export">export zip</button>
    </div>
    <div>
      <iframe src="about:blank"></iframe>
    </div>
    <script>
      const add_song = document.querySelector("#add_song");
      const song_template = document.querySelector('#song');
      add_song.onclick = () => {
        const song = document.importNode(song_template.content, true);
        const div = song.querySelector("div");

        song.querySelector(".remove_song").onclick = () => {
          div.parentElement.removeChild(div);
        }

        const add_song_parent = add_song.parentElement;
        add_song_parent.parentElement.insertBefore(song, add_song_parent);
      }
      function get_filename(el, final) {
        const file = el.files[0]
        if (final) {
          return file ? file.name : "";
        } else {
          return file ? URL.createObjectURL(file) : "";
        }
      }
      async function get_audio_duration(filename) {
        const tmp_audio = new Audio();
        const {data} = await new Promise(resolve => {
          tmp_audio.addEventListener('loadedmetadata', resolve, {once:true});
          tmp_audio.src = filename;
        });
        console.log(tmp_audio.duration);
        const duration = Math.ceil(tmp_audio.duration);
        return Math.floor(duration / 60) + ":" + String(duration % 60).padStart(2, '0');
      }
      async function serialize(final) {
        const songs = document.querySelectorAll(".song");
        let data = {};
        data.blamscamp_version = "0.0.1";
        data.album = document.querySelector("#album").value;
        data.artist = document.querySelector("#artist").value;
        data.cover = get_filename(document.querySelector('#cover'), final);
        data.songs = [];
        for (let idx = 0; idx < songs.length; idx++) {
          const file_el = songs[idx].querySelector(".song_file");
          song = {};
          song.idx = idx + 1;
          song.title = songs[idx].querySelector(".song_title").value;
          song.filename = get_filename(file_el, final);
          song.time = await get_audio_duration(get_filename(file_el, false));
          data.songs[idx] = song;
        }
        return data;
      }
      function deserialize(zip) {

      }
      function run(template) {
        const template_song = template.match(/\[:\[song_start\]:\](.*)\[:\[song_end\]:\]/)[1];
        const template_body = template.replace(/\[:\[song_start\]:\].*\[:\[song_end\]:\]/, "[:[songs]:]");
        function generate(data) {
          let out = template_body;
          let songs = data.songs.map((s, idx) => {
            let song = template_song;
            song = song.replaceAll("[:[index]:]", idx + 1);
            song = song.replaceAll("[:[title]:]", s.title);
            song = song.replaceAll("[:[filename]:]", s.filename);
            song = song.replaceAll("[:[time]:]", s.time);
            return song;
          })
          out = out.replaceAll("[:[album]:]", data.album);
          out = out.replaceAll("[:[artist]:]", data.artist);
          out = out.replaceAll("[:[cover]:]", data.cover);
          out = out.replaceAll("[:[songs]:]", songs.join("\n"));
          return out;
        }
        document.querySelector("#export").onclick = async (e) => {
          const data = await serialize(false);
          let zip = new JSZip();
          zip.file('blamscamp.json', JSON.stringify(data));
          zip.file('index.html', generate(data));
          const files = document.querySelectorAll("input[type='file']");
          for (let idx = 0; idx < files.length; idx++) {
            const file = files[idx].files[0];
            if (file) {
              const fileReader = new FileReader();
              zip.file(file.name, await file.arrayBuffer());
            }
          }
          zip.generateAsync({type:"blob"})
          .then(function (blob) {
            const a = document.createElement('a');
            a.download = data.album + "_blamscamp.zip";
            a.href = URL.createObjectURL(blob);
            a.click();
            URL.revokeObjectURL(a.href);
          });
        };
        document.querySelector("#generate").onclick = async (e) => {
          const data = await serialize(false);
          document.querySelector("iframe").srcdoc = generate(data);
        };
      }
      fetch('_index.html', {method: 'GET'})
      .then(response => response.text())
      .then(text => run(text))
      .catch(error => console.error('error:', error));

    </script>
    <style type="text/css">
html {
  background: grey;
  height: 100%;
}

body {
  font-family: sans-serif;
  background: white;
  display: grid;
  grid-template-rows: 1fr 1fr;
  max-width: 960px;
  width: 100%;
  height: 100%;
  margin: auto;
}

.editor {
  margin: 0 0 0 10px;
  overflow-y: scroll;
}

h1, h2, h3, p {
  margin: 10px 0;
}

iframe {
  width: 100%;
  height: 100%;
  border: 1px solid grey;
  box-sizing: border-box;
}

.well {
    padding: 5px 10px;
    border: 1px solid #ddd;
    margin: 5px 0;
    max-width: 80%;
    background: #eee;
}

input {
  margin: 10px 0;
}

button {
  margin: 5px 0;
  border-radius: 0;
  padding: 4px 8px;
  border: 1px solid grey;
  background-color: #eee;
  text-align: center;
  vertical-align: middle;
  cursor: pointer;
  flex-shrink: 0;
}

button:hover {
  background-color: #e6e6e6;
}

.song {
    display: flex;
    align-items: center;
}

.well > * {
    margin: 0 5px
}

.song_title {
    flex-grow: 1;
}

.meta_fields {
  width: 450px;
  max-width: 90%;
  font-size: 120%;
}

    </style>
  </body>
</html>
