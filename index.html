<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>blamscamp player</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <template id="song">
    <div class="song well">
      <button class="remove_song">remove song</button>
      <input class="song_title" type="text" placeholder="song title"/>
      <input class="song_file" type="file"/>
    </div>
  </template>
  <body>
    <div class="editor">
      <h1>blamscamp player</h1>
      <p>create a bandcamp-style audio player for selling albums on itch.io</p>
      <!-- <button>import zip</button> -->
      <div><input type="text" placeholder="album title" id="album"/></div>
      <div><input type="text" placeholder="artist name" id="artist"/></div>
      <div>cover art: <input type="file" id="cover"/></div>
      <div class="songs">
        <div class="song well">
          <button id="add_song">add song</button>
        </div>
      </div>

      <button id="generate">generate</button>
    </div>
    <div>
      <iframe src="about:blank"></iframe>
    </div>
    <script>
      const add_song = document.querySelector("#add_song");
      add_song.onclick = () => {
        const template = document.querySelector('#song');
        const song = document.importNode(template.content, true);
        const add_song_parent = add_song.parentElement;
        add_song_parent.parentElement.insertBefore(song, add_song_parent);

        console.log(song);
        song.querySelector(".remove_song").onclick = () => {
          song.parentElement.removeChild(song);
        }
      }
      function serialize(final) {
        let data = {};
        data.blamscamp_version = "0.0.1";
        data.album = document.querySelector("#album").value;
        data.artist = document.querySelector("#artist").value;
        const file = document.querySelector('#cover').files[0];
        if (final) {
          data.cover = file ? file.name : "";
        } else {
          data.cover = file ? URL.createObjectURL(file) : "";
        }
        data.songs = [];
        console.log(data.cover);
        return data;
      }
      function deserialize(data) {

      }
      function run(template) {
        const template_song = template.match(/\[:\[song_start\]:\](.*)\[:\[song_end\]:\]/)[1];
        const template_body = template.replace(/\[:\[song_start\]:\].*\[:\[song_end\]:\]/, "[:[songs]:]");
        function generate(data) {
          let out = template_body;
          let songs = data.songs.map((s, idx) => {
            let song = template_song;
            song = song.replaceAll("[:[index]:]", idx + 1);
            song = song.replaceAll("[:[title]:]", s.title);
            song = song.replaceAll("[:[filename]:]", s.filename);
            song = song.replaceAll("[:[time]:]", s.time);
            return song;
          })
          out = out.replaceAll("[:[album]:]", data.album);
          out = out.replaceAll("[:[artist]:]", data.artist);
          out = out.replaceAll("[:[cover]:]", data.cover);
          out = out.replaceAll("[:[songs]:]", songs.join("\n"));
          return out;
        }
//         const gend = generate({
//   "blamscamp_version": "0.0.1",
//   "album": "titled songs",
//   "artist": "blackle mori",
//   "cover": "cover.jpg",
//   "songs": [
//     {
//       "title": "pitiful",
//       "length": "1:21",
//       "filename": "pitiful.mp3"
//     },
//     {
//       "title": "username",
//       "length": "0:59",
//       "filename": "username.mp3"
//     },
//     {
//       "title": "renamon",
//       "length": "2:53",
//       "filename": "renamon.mp3"
//     },
//   ],
//   "settings": {
//     "background-color": "#fff",
//     "color": "#000",
//     "highlight-color": "#434",
//     "button-background-color": "#fff",
//     "button-foreground-color": "#000",
//     "extra-css": ""
//   }
// });
        document.querySelector("#generate").onclick = (e) => {
          document.querySelector("iframe").srcdoc = generate(serialize(false));
        };
      }
      fetch('_index.html', {method: 'GET'})
      .then(response => response.text())
      .then(text => run(text))
      .catch(error => console.error('error:', error));

    </script>
    <style type="text/css">
html {
  background: grey;
  height: 100%;
}

body {
  font-family: sans-serif;
  background: white;
  display: grid;
  grid-template-rows: 1fr 1fr;
  max-width: 960px;
  width: 100%;
  height: 100%;
  margin: auto;
}

.editor {
  margin: 0 0 0 10px;
  overflow-y: scroll;
}

h1, h2, h3, p {
  margin: 10px 0;
}

iframe {
  width: 100%;
  height: 100%;
  border: 1px solid grey;
  box-sizing: border-box;
}

.well {
    padding: 5px 10px;
    border: 1px solid #ddd;
    margin: 5px 0;
    max-width: 80%;
    background: #eee;
}

input {
  margin: 10px 0;
}

button {
  margin: 5px 0;
  border-radius: 0;
  padding: 4px 8px;
  border: 1px solid grey;
  background-color: #eee;
  text-align: center;
  vertical-align: middle;
  cursor: pointer;
  flex-shrink: 0;
}

button:hover {
  background-color: #e6e6e6;
}

    </style>
  </body>
</html>
