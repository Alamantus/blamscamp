<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>blamscamp player</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script type="text/javascript" src="jszip.min.js"></script>
  </head>
  <template id="song">
    <div class="song well">
      <button type="button" class="remove_song">remove song</button>
      <input class="song_title" type="text" placeholder="song title"/>
      <input class="song_file" type="file"/>
    </div>
  </template>
  <body>
    <div class="editor">
      <h1>blamscamp editor</h1>
      <p>create a bandcamp-style audio player for selling albums on itch.io</p>
      <!-- <button>import zip</button> -->
      <form id="editor">
        <div><input class="meta_fields" type="text" placeholder="album title" id="album"/></div>
        <div><input class="meta_fields" type="text" placeholder="artist name" id="artist"/></div>
        <div>cover art: <input type="file" id="cover"/></div>
        <div class="songs">
          <div class="well">
            <button type="button" id="add_song">add song</button>
          </div>
        </div>
        <div><input type="color" value="#ffffff" id="background_color"/> background</div>
        <div><input type="color" value="#000000" id="foreground_color"/> foreground</div>
        <div><input type="color" value="#000000" id="highlight_color"/> highlight</div>

        <button type="button" id="generate">generate</button>
        <button type="button" id="export">export zip</button> <div id="export_spinner" class="spinner hidden"></div>
        <button type="button" id="import">import zip</button> <div id="import_spinner" class="spinner hidden"></div>
        <input type="file" accept="application/zip" id="zip_input" class="hidden"/>
      </form>
    </div>
    <div>
      <iframe src="about:blank"></iframe>
    </div>
    <script>
      const form = document.getElementById('editor');
      const export_button = document.querySelector("#export");
      const import_button = document.querySelector("#import");
      const zip_input = document.querySelector("#zip_input");
      const export_spinner = document.querySelector("#export_spinner");
      const import_spinner = document.querySelector("#import_spinner");
      const add_song = document.querySelector("#add_song");
      const song_template = document.querySelector('#song');

      const add_blank_song = () => {
        const song = document.importNode(song_template.content, true);
        const div = song.querySelector("div");

        song.querySelector(".remove_song").onclick = () => {
          div.parentElement.removeChild(div);
        }
        const add_song_parent = add_song.parentElement;
        add_song_parent.parentElement.insertBefore(song, add_song_parent);
        return div;
      };
      add_song.onclick = add_blank_song;

      function get_filename(el, final) {
        const file = el.files[0]
        if (final) {
          return file ? file.name : "";
        } else {
          return file ? URL.createObjectURL(file) : "";
        }
      }
      async function get_audio_duration(filename) {
        const tmp_audio = new Audio();
        const {data} = await new Promise(resolve => {
          tmp_audio.addEventListener('loadedmetadata', resolve, {once:true});
          tmp_audio.src = filename;
        });
        console.debug(filename, tmp_audio.duration);
        const duration = Math.ceil(tmp_audio.duration);
        return Math.floor(duration / 60) + ":" + String(duration % 60).padStart(2, '0');
      }
      async function serialize(final) {
        const songs = document.querySelectorAll(".song");
        let data = {};
        data.blamscamp_version = "0.0.1";
        data.album = document.querySelector("#album").value;
        data.artist = document.querySelector("#artist").value;
        const cover_input = document.querySelector("#cover");
        if (final) {
          data.cover = get_filename(document.querySelector('#cover'), final) || cover_input.cover_filename;
        } else {
          data.cover = get_filename(document.querySelector('#cover'), final) || cover_input.cover_fileurl;
        }
        data.songs = [];
        for (let idx = 0; idx < songs.length; idx++) {
          const file_el = songs[idx].querySelector(".song_file");
          song = {};
          song.idx = idx + 1;
          song.title = songs[idx].querySelector(".song_title").value;
          if (file_el.value) {
            song.filename = get_filename(file_el, final);
            song.time = await get_audio_duration(get_filename(file_el, false));
          } else {
            const song_tag = file_el.closest('.song')
            if (final) {
              song.filename = song_tag.song_filename || '';
            } else {
              song.filename = song_tag.song_fileurl;
            }
            song.time = await get_audio_duration(song_tag.song_fileurl);
          }
          data.songs[idx] = song;
        }
        data.settings = {};
        data.settings.background_color = document.querySelector("#background_color").value;
        data.settings.foreground_color = document.querySelector("#foreground_color").value;
        data.settings.highlight_color = document.querySelector("#highlight_color").value;
        return data;
      }
      async function deserialize(file) {
        const archive = await JSZip.loadAsync(file);
        console.debug(archive);
        if (!('blamscamp.json' in archive.files)) {
          alert('Cannot find blamscamp.json in the zip archive. Make sure you select a file you exported with blamscamp.');
          return;
        }
        const data = JSON.parse(await archive.files['blamscamp.json'].async('text'));
        console.debug(data);
        for (const key of ['album', 'artist']) {
          form.elements[key].value = data[key];
        }
        for (const key of ['background_color', 'foreground_color', 'highlight_color']) {
          form.elements[key].value = data.settings[key];
        }
        document.querySelector('.songs').childNodes.forEach(node => {
          if (node.nodeType === 1 && node.classList.contains('song')) {
            node.parentElement.removeChild(node);
          }
        });
        const promises = [];
        // Deserialize songs. We can't write the file back to the input[type="file"] tag,
        // so we attach the read file and all the needed information to the song's HTML tag.
        for (const song of data.songs) {
          const song_tag = add_blank_song();
          promises.push(
            archive.files[song.filename].async('blob')
            .then(blob => {
              song_tag.song_blob = blob;
              song_tag.song_fileurl = URL.createObjectURL(blob);
              song_tag.song_filename = song.filename;
              song_tag.querySelector('.song_title').value = song.title;
            })
          );
        }
        // Do the same for the cover image. Store needed data in the input tag.
        if (data.cover) {
          const cover_input = document.querySelector('#cover');
          cover_input.cover_filename = data.cover;
          cover_input.cover_blob = await archive.files[data.cover].async('blob');
          cover_input.cover_fileurl = URL.createObjectURL(cover_input.cover_blob);
          await Promise.all(promises);
        }
      };
      function run(template) {
        const template_song = template.match(/\[:\[song_start\]:\](.*)\[:\[song_end\]:\]/)[1];
        const template_body = template.replace(/\[:\[song_start\]:\].*\[:\[song_end\]:\]/, "[:[songs]:]");
        function generate(data) {
          let out = template_body;
          let songs = data.songs.map((s, idx) => {
            let song = template_song;
            song = song.replaceAll("[:[index]:]", idx + 1);
            song = song.replaceAll("[:[title]:]", s.title);
            song = song.replaceAll("[:[filename]:]", s.filename);
            song = song.replaceAll("[:[time]:]", s.time);
            return song;
          })
          out = out.replaceAll("[:[album]:]", data.album);
          out = out.replaceAll("[:[artist]:]", data.artist);
          out = out.replaceAll("[:[cover]:]", data.cover);
          out = out.replaceAll("[:[songs]:]", songs.join("\n"));
          out = out.replaceAll("[:[background_color]:]", data.settings.background_color);
          out = out.replaceAll("[:[foreground_color]:]", data.settings.foreground_color);
          out = out.replaceAll("[:[highlight_color]:]", data.settings.highlight_color);
          return out;
        }
        export_button.onclick = async (e) => {
          export_button.disabled = true;
          export_spinner.classList.remove("hidden");
          const data = await serialize(true);
          let zip = new JSZip();
          zip.file('blamscamp.json', JSON.stringify(data));
          zip.file('index.html', generate(data));
          const songs = document.querySelectorAll('.song');
          for (const song of songs) {
            const file = song.querySelector("input[type='file']").files[0];
            if (file) {
              zip.file(file.name, await file.arrayBuffer());
            } else {
              zip.file(song.song_filename, song.song_blob);
            }
          }
          const cover_input = document.querySelector('#cover');
          if (cover_input.files[0]) {
            const cover_file = cover_input.files[0];
            zip.file(cover_file.name, await cover_file.arrayBuffer());
          } else if (cover_input.cover_blob) {
            zip.file(cover_input.cover_filename, cover_input.cover_blob);
          }
          zip.generateAsync({type:"blob"})
          .then(function (blob) {
            const a = document.createElement('a');
            a.download = data.album + "_blamscamp.zip";
            a.href = URL.createObjectURL(blob);
            a.click();
            URL.revokeObjectURL(a.href);
            export_button.disabled = false;
            export_spinner.classList.add("hidden");
          });
        };
        const make_preview = async () => {
          const data = await serialize(false);
          document.querySelector("iframe").srcdoc = generate(data);
        }
        document.querySelector("#generate").onclick = () => {
          make_preview();
        };
        form.addEventListener("submit", e => {
          e.preventDefault();
          make_preview();
        });
        import_button.onclick = () => {
          zip_input.click();
        };
        zip_input.onchange = async e => {
          import_spinner.classList.remove("hidden");
          import_button.disabled = true;
          const file = e.target.files[0];
          try {
            await deserialize(file);
          } catch (error) {
            throw error;
          }
          import_button.disabled = false;
          import_spinner.classList.add("hidden");
          make_preview();
          e.target.value = '';
        };
      };
      fetch('template.html', {method: 'GET'})
      .then(response => response.text())
      .then(text => run(text))
      .catch(error => console.error('error:', error));

    </script>
    <style type="text/css">
html {
  background: grey;
  height: 100%;
}

body {
  font-family: sans-serif;
  background: white;
  display: grid;
  grid-template-rows: 1fr 1fr;
  max-width: 960px;
  width: 100%;
  height: 100%;
  margin: auto;
}

.editor {
  margin: 0 0 0 10px;
  overflow-y: scroll;
}

h1, h2, h3, p {
  margin: 10px 0;
}

iframe {
  width: 100%;
  height: 100%;
  border: 1px solid grey;
  box-sizing: border-box;
}

.well {
    padding: 5px 10px;
    border: 1px solid #ddd;
    margin: 5px 0;
    max-width: 80%;
    background: #eee;
}

input {
  margin: 10px 0;
}
input[type='color'] {
  margin: 5px 0;
}

button {
  margin: 5px 0;
  border-radius: 0;
  padding: 4px 8px;
  border: 1px solid grey;
  background-color: #eee;
  text-align: center;
  vertical-align: middle;
  cursor: pointer;
  flex-shrink: 0;
}

button:hover {
  background-color: #e6e6e6;
}

.song {
    display: flex;
    align-items: center;
}

.well > * {
    margin: 0 5px
}

.song_title {
    flex-grow: 1;
}

.meta_fields {
  width: 450px;
  max-width: 90%;
  font-size: 120%;
}

.spinner {
  background: url('data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%20-256%201792%201792%22%3E%3Cpath%20d%3D%22M617.492%201123.797q0%2060-42.5%20102t-101.5%2042q-60%200-102-42t-42-102q0-60%2042-102t102-42q59%200%20101.5%2042t42.5%20102zm432%20192q0%2053-37.5%2090.5t-90.5%2037.5q-53%200-90.5-37.5t-37.5-90.5q0-53%2037.5-90.5t90.5-37.5q53%200%2090.5%2037.5t37.5%2090.5zm-608-640q0%2066-47%20113t-113%2047q-66%200-113-47t-47-113q0-66%2047-113t113-47q66%200%20113%2047t47%20113zm1040%20448q0%2046-33%2079t-79%2033q-46%200-79-33t-33-79q0-46%2033-79t79-33q46%200%2079%2033t33%2079zm-832-896q0%2073-51.5%20124.5t-124.5%2051.5q-73%200-124.5-51.5t-51.5-124.5q0-73%2051.5-124.5t124.5-51.5q73%200%20124.5%2051.5t51.5%20124.5zm464-192q0%2080-56%20136t-136%2056q-80%200-136-56t-56-136q0-80%2056-136t136-56q80%200%20136%2056t56%20136zm544%20640q0%2040-28%2068t-68%2028q-40%200-68-28t-28-68q0-40%2028-68t68-28q40%200%2068%2028t28%2068zm-208-448q0%2033-23.5%2056.5t-56.5%2023.5q-33%200-56.5-23.5t-23.5-56.5q0-33%2023.5-56.5t56.5-23.5q33%200%2056.5%2023.5t23.5%2056.5z%22%2F%3E%3C%2Fsvg%3E');
  width: 20px;
  height: 20px;
  background-size: contain;
  background-position: center;
  animation: spin 2s ease-in-out infinite;
  display: inline-block;
  vertical-align: middle;
}

.hidden {
  display: none;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
    </style>
  </body>
</html>
